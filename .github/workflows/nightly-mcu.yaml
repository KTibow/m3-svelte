name: Nightly MCU release

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  nightly-mcu:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout upstream
        uses: actions/checkout@v6
        with:
          repository: material-foundation/material-color-utilities
          path: upstream

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: latest
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        working-directory: upstream/typescript
        run: npm install

      - name: Add missing export
        working-directory: upstream/typescript
        run: |
          echo >> index.ts
          echo "export * from './dynamiccolor/contrast_curve.js';" >> index.ts

      - name: Fix TypeScript config for nightly
        working-directory: upstream/typescript
        run: |
          node -p "
            const config = require('./tsconfig.json');
            config.compilerOptions.noUnusedLocals = false;
            config.compilerOptions.noUnusedParameters = false;
            JSON.stringify(config, null, 2);
          " > tsconfig.tmp.json
          mv tsconfig.tmp.json tsconfig.json

      - name: Install linting tools
        working-directory: upstream/typescript
        run: npm install --save-dev eslint @eslint/js typescript-eslint eslint-plugin-import eslint-import-resolver-typescript

      - name: Write linter config to filesystem
        working-directory: upstream/typescript
        run: |
          echo 'import js from "@eslint/js";
            import ts from "typescript-eslint";
            import pluginImport from "eslint-plugin-import";

            export default [
              {
                ignores: [
                  "**/*.d.ts", // prevent declaration file parsing
                  "**/*.js", // ignore generated JS files
                  ".wireit/**", // ignore build cache
                  "node_modules/**", // ignore dependencies
                ],
              },

              js.configs.recommended,

              {
                files: ["**/*.ts"],
                ignores: ["**/*test.ts", "**/*.test.ts"],
                ...Object.assign({}, ...ts.configs.recommended),

                languageOptions: {
                  parser: ts.parser,
                  parserOptions: {
                    project: true,
                  },
                },

                plugins: {
                  import: pluginImport,
                },

                rules: {
                  "no-unused-vars": "off",
                  "no-undef": "off",

                  "no-case-declarations": "off",

                  "import/extensions": [
                    "error",
                    "always",
                    {
                      ts: "never",
                    },
                  ],
                },

                settings: {
                  "import/resolver": {
                    typescript: {
                      alwaysTryTypes: true,
                    },
                  },
                },
              },

              {
                files: ["**/*test.ts", "**/*.test.ts"],
                ...Object.assign({}, ...ts.configs.recommended),

                languageOptions: {
                  parser: ts.parser,
                  parserOptions: {
                    project: false,
                  },
                  globals: {
                    describe: "readonly",
                    it: "readonly",
                    expect: "readonly",
                    beforeEach: "readonly",
                    jasmine: "readonly",
                  },
                },

                plugins: {
                  import: pluginImport,
                },

                rules: {
                  "no-unused-vars": "off",
                  "no-undef": "off",

                  "no-case-declarations": "off",

                  "import/extensions": [
                    "error",
                    "always",
                    {
                      ts: "never",
                    },
                  ],
                },
              },
            ];
          ' > eslint.config.js

      - name: Run linter
        working-directory: upstream/typescript
        run: npx eslint . --ext .ts --max-warnings=0 --fix

      - name: Build package
        working-directory: upstream/typescript
        run: npm run build

      - name: Fix import extensions for Node.js compatibility
        working-directory: upstream/typescript
        run: |
          # Add .js extensions to relative imports that don't already have them
          find . -name "*.js" -not -path "./node_modules/*" -exec sed -i "s|from '\(\.\.*/[^']*\)';|from '\1.js';|g" {} +
          # Clean up any double .js.js that resulted
          find . -name "*.js" -not -path "./node_modules/*" -exec sed -i "s|\.js\.js';|.js';|g" {} +

      - name: Update package.json for nightly
        working-directory: upstream/typescript
        run: |
          LAST_COMMIT_TIMESTAMP=$(git log -1 --format="%ct") node -p "
            const pkg = require('./package.json');
            pkg.name = '@ktibow/material-color-utilities-nightly';
            const lastCommit = parseInt(process.env.LAST_COMMIT_TIMESTAMP) * 1000;
            if (!lastCommit) throw new Error(`${process.env.LAST_COMMIT_TIMESTAMP} is not a valid timestamp`);
            pkg.version += lastCommit.toString();
            pkg.sideEffects = false;
            delete pkg.scripts.prepublishOnly;
            JSON.stringify(pkg, null, 2);
          " > package.tmp.json
          mv package.tmp.json package.json
        env:
          NIGHTLY_VERSION: ${{ env.NIGHTLY_VERSION }}

      - name: Publish to npm
        working-directory: upstream/typescript
        run: npm publish --access public --tag latest || exit 0
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
